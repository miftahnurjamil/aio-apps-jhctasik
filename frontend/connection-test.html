<!DOCTYPE html>
<html>
  <head>
    <title>Broadcast System - Connection Test</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 50px auto;
        padding: 20px;
        background: #f5f5f5;
      }
      .status {
        padding: 20px;
        background: #fff;
        border-radius: 5px;
        margin: 10px 0;
      }
      .success {
        color: #0f0;
        background: #0f0222;
      }
      .error {
        color: #f00;
        background: #f0f0f0;
      }
      .warning {
        color: #ff0;
        background: #f5f5f5;
      }
      button {
        padding: 10px 20px;
        margin: 10px 0;
        cursor: pointer;
      }
      #log {
        background: #222;
        color: #0f0;
        padding: 20px;
        border-radius: 5px;
        min-height: 200px;
        max-height: 400px;
        overflow-y: auto;
        font-family: monospace;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <h1>JHC Broadcast System - Connection Test</h1>

    <div id="status" class="status error">
      <strong>Status:</strong> Initializing...
    </div>

    <div>
      <button onclick="testConnection()">Test Connection</button>
      <button onclick="testBroadcast()">Send Test Broadcast</button>
      <button onclick="clearLog()">Clear Log</button>
    </div>

    <div id="log"></div>

    <script>
      let socket = null;

      function log(msg, type = "info") {
        const logDiv = document.getElementById("log");
        const line = document.createElement("div");
        line.style.color =
          type === "error" ? "#f00" : type === "success" ? "#0f0" : "#ff0";
        line.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
        logDiv.appendChild(line);
        logDiv.scrollTop = logDiv.scrollHeight;
        console.log(msg);
      }

      function clearLog() {
        document.getElementById("log").innerHTML = "";
      }

      function updateStatus(msg, isSuccess) {
        const statusDiv = document.getElementById("status");
        statusDiv.innerHTML = `<strong>Status:</strong> ${msg}`;
        statusDiv.className = "status " + (isSuccess ? "success" : "error");
      }

      function testConnection() {
        log("ðŸ§ª Testing connection...", "info");

        // Detect server URL
        let serverUrl;
        if (
          window.location.hostname === "localhost" ||
          window.location.hostname === "127.0.0.1"
        ) {
          serverUrl = "http://localhost:3000";
        } else {
          const protocol =
            window.location.protocol === "https:" ? "https" : "http";
          serverUrl = `${protocol}//${window.location.hostname}:3000`;
        }

        log(`Frontend: ${window.location.href}`, "info");
        log(`Server URL: ${serverUrl}`, "info");

        // Disconnect old socket if exists
        if (socket) {
          socket.disconnect();
        }

        socket = io(serverUrl, {
          reconnection: true,
          reconnectionDelay: 1000,
          reconnectionDelayMax: 5000,
          reconnectionAttempts: 5,
          transports: ["websocket", "polling"],
        });

        socket.on("connect", () => {
          log("âœ… Connected! Socket ID: " + socket.id, "success");
          updateStatus("âœ… Connected to broadcast server", true);
        });

        socket.on("disconnect", () => {
          log("âŒ Disconnected from server", "error");
          updateStatus("âŒ Disconnected", false);
        });

        socket.on("connect_error", (error) => {
          log(`âŒ Connection error: ${error.message}`, "error");
          updateStatus("âŒ Connection failed: " + error.message, false);
        });

        socket.on("play-announcement", (data) => {
          log("ðŸ“¢ Received announcement broadcast", "success");
          const audio = new Audio(data.audioUrl);
          audio.volume = 0.5;
          audio
            .play()
            .catch((e) => log("Audio play error: " + e.message, "error"));
        });

        socket.on("play-code", (data) => {
          log(`ðŸš¨ Received code broadcast: ${data.codeName}`, "success");
        });
      }

      function testBroadcast() {
        if (!socket || !socket.connected) {
          log("âŒ Not connected to server", "error");
          return;
        }

        log("ðŸ“¤ Sending test announcement...", "info");

        // Create a simple beep sound in Base64
        const beepBase64 =
          "data:audio/wav;base64,UklGRiYAAABXQVZFZm10IBAAAAABAAEAQB8AAAB9AAACABAAZGF0YQIAAAAAAA==";

        socket.emit("broadcast-announcement", {
          audioUrl: beepBase64,
          duration: 1,
        });

        log("âœ… Test broadcast sent", "success");
      }

      // Auto test when page loads
      window.addEventListener("load", () => {
        log("ðŸš€ Page loaded, testing connection automatically...", "info");
        setTimeout(testConnection, 1000);
      });
    </script>
  </body>
</html>
